# =============================================================================
# MasterClawInterface — Docker Compose (Self-Hosted)
# =============================================================================
# Usage:
#   1. Copy .env.production → .env  and fill in your values
#   2. Replace YOUR_DOMAIN in Caddyfile with your actual domain (or localhost)
#   3. docker compose up -d
# =============================================================================

services:
  # ── Caddy Reverse Proxy + Static Frontend ──
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp" # HTTP/3 (QUIC)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./frontend/dist:/srv/frontend:ro # Static frontend build
      - caddy_data:/data # TLS certificates
      - caddy_config:/config
    depends_on:
      backend:
        condition: service_started

  # ── Express + Socket.IO Backend ──
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    expose:
      - "3001"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - PORT=3001
    volumes:
      - backend_data:/app/data # SQLite persistence

volumes:
  caddy_data:
  caddy_config:
  backend_data:
